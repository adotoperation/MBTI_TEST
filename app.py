import os
import random
import datetime
import threading
import webbrowser
import csv
from flask import Flask, render_template, request

app = Flask(__name__)

# 80문항 전체 데이터
QUESTIONS_DATA = [
    # 외향(E) vs 내향(I) - 20문항
    {"type": "EI", "text": "강사 휴게실에서 동료들과 대화하며 쉬는 것이 활력이 된다."},
    {"type": "EI", "text": "학원 회의에서 내 의견을 바로 발표하는 편이다."},
    {"type": "EI", "text": "학생이 많은 교실에서 강의할 때 더 에너지가 넘친다."},
    {"type": "EI", "text": "처음 보는 학부모와의 상담도 크게 긴장되지 않는다."},
    {"type": "EI", "text": "새로운 강사가 오면 먼저 다가가 말을 건다."},
    {"type": "EI", "text": "생각을 말로 표현하면서 정리하는 것이 편하다."},
    {"type": "EI", "text": "여러 명과 함께 교재 제작을 하는 것을 즐긴다."},
    {"type": "EI", "text": "전화 상담보다 문자로 대화하는 것이 에너지가 더 든다."},
    {"type": "EI", "text": "관심받는 것을 즐기며, 칭찬을 들으면 힘이 솟는다."},
    {"type": "EI", "text": "동료 강사들과 퇴근 후 번개 모임을 즐긴다."},
    {"type": "EI", "text": "회의 시간에 침묵이 흐르면 먼저 깨고 싶어 한다."},
    {"type": "EI", "text": "주말에는 외부 활동을 하는 것을 선호한다."},
    {"type": "EI", "text": "행동이 빠르고 결론을 빨리 내고 싶어 한다."},
    {"type": "EI", "text": "나의 업무 성과를 남들에게 알리는 데 주저함이 없다."},
    {"type": "EI", "text": "모르는 사람들과의 모임에도 기꺼이 참여한다."},
    {"type": "EI", "text": "활기차고 열정적인 강사라는 소리를 자주 듣는다."},
    {"type": "EI", "text": "업무 지시를 받을 때 대면 보고가 더 명확하다."},
    {"type": "EI", "text": "주변에 사람이 많을수록 아이디어가 잘 떠오른다."},
    {"type": "EI", "text": "다양한 사람들과 인맥을 쌓는 것이 즐겁다."},
    {"type": "EI", "text": "혼자 집중하는 시간보다 협업하는 시간이 더 짧게 느껴진다."},

    # 감각(S) vs 직관(N) - 20문항
    {"type": "SN", "text": "구체적인 사례를 들어 설명하는 것이 추상적 비유보다 편하다."},
    {"type": "SN", "text": "기존에 검증된 수업 방식을 유지하는 것을 선호한다."},
    {"type": "SN", "text": "학생의 현재 성적 수치를 분석하는 것이 잠재력을 보는 것보다 중요하다."},
    {"type": "SN", "text": "매뉴얼을 꼼꼼하게 읽고 업무를 시작한다."},
    {"type": "SN", "text": "현실적으로 실현 가능한 목표를 세우는 것을 좋아한다."},
    {"type": "SN", "text": "세부 사항을 놓치지 않는 꼼꼼함이 나의 장점이다."},
    {"type": "SN", "text": "과거의 경험을 바탕으로 문제를 해결하는 편이다."},
    {"type": "SN", "text": "실제 일어난 사실에 대해 이야기하는 것을 좋아한다."},
    {"type": "SN", "text": "복잡한 이론보다 바로 쓸 수 있는 수업 스킬이 더 좋다."},
    {"type": "SN", "text": "관찰력이 좋아 학생의 작은 변화를 잘 알아챈다."},
    {"type": "SN", "text": "단계별로 차근차근 업무를 진행하는 것을 선호한다."},
    {"type": "SN", "text": "상상력이 풍부하기보다 현실적이라는 말을 자주 듣는다."},
    {"type": "SN", "text": "구체적인 근거가 있어야 상대의 말을 신뢰한다."},
    {"type": "SN", "text": "주변 정리가 깔끔해야 업무 효율이 오른다."},
    {"type": "SN", "text": "사건의 전체 맥락보다 세부 팩트가 더 궁금하다."},
    {"type": "SN", "text": "전통과 관습을 존중하고 따르는 편이다."},
    {"type": "SN", "text": "반복적인 업무라도 정확히 해내는 것에 보람을 느낀다."},
    {"type": "SN", "text": "직접 경험한 것을 가장 신뢰한다."},
    {"type": "SN", "text": "업무 지시가 '적당히', '알아서'라면 혼란스럽다."},
    {"type": "SN", "text": "미래의 구상보다 현재의 실행이 더 가치 있다."},

    # 사고(T) vs 감정(F) - 20문항
    {"type": "TF", "text": "학생이 숙제를 안 왔을 때 사정보다 원칙대로 피드백한다."},
    {"type": "TF", "text": "감정적 배려보다 솔직하고 객관적인 지적이 낫다."},
    {"type": "TF", "text": "문제 해결 시 논리적 분석이 사람의 기분보다 우선이다."},
    {"type": "TF", "text": "옳고 그름을 분명히 가리는 것을 좋아한다."},
    {"type": "TF", "text": "타인의 고민에 공감보다 해결책을 먼저 제시한다."},
    {"type": "TF", "text": "공정함은 예외 없는 규칙 적용에서 온다고 믿는다."},
    {"type": "TF", "text": "업무 평가 시 성과 위주로 판단하는 것이 당연하다."},
    {"type": "TF", "text": "지나치게 감성적인 사람을 보면 가끔 이해하기 힘들다."},
    {"type": "TF", "text": "비판적인 사고가 더 나은 결과를 만든다고 생각한다."},
    {"type": "TF", "text": "나의 결정이 타인에게 상처를 주더라도 옳은 일이면 추진한다."},
    {"type": "TF", "text": "감정적인 호소보다 논리적인 설득이 더 잘 통한다."},
    {"type": "TF", "text": "친절한 강사보다 실력 있는 강사라는 말이 더 듣기 좋다."},
    {"type": "TF", "text": "결과가 좋지 않다면 그 과정에서의 노력은 의미가 퇴색된다."},
    {"type": "TF", "text": "회의 시 개인적인 친분과 업무적 판단을 확실히 구분한다."},
    {"type": "TF", "text": "칭찬을 들을 때 '고생했다'보다 '잘했다'는 말이 더 좋다."},
    {"type": "TF", "text": "사적인 감정이 업무 효율을 방해해서는 안 된다."},
    {"type": "TF", "text": "진실을 말하는 것이 상대의 기분을 맞추는 것보다 중요하다."},
    {"type": "TF", "text": "객관적인 지표로 보상받는 것이 동기부여가 된다."},
    {"type": "TF", "text": "싸울 때 감정이 상하기보다 논리가 안 맞을 때 더 화난다."},
    {"type": "TF", "text": "효율성을 따지는 것이 시간 낭비보다 훨씬 낫다."},

    # 판단(J) vs 인식(P) - 20문항
    {"type": "JP", "text": "수업 진도 계획이 틀어지면 스트레스를 받는다."},
    {"type": "JP", "text": "업무 시작 전 체크리스트를 작성하는 습관이 있다."},
    {"type": "JP", "text": "마감 기한보다 훨씬 일찍 업무를 끝내야 마음이 편하다."},
    {"type": "JP", "text": "책상이 항상 정리되어 있어야 집중이 잘 된다."},
    {"type": "JP", "text": "여행을 갈 때 시간 단위로 계획을 짜는 편이다."},
    {"type": "JP", "text": "한 번 정한 규칙은 최대한 지키려 노력한다."},
    {"type": "JP", "text": "돌발 상황이 생기는 것을 매우 싫어한다."},
    {"type": "JP", "text": "결정을 미루기보다 빨리 확정 짓는 것이 좋다."},
    {"type": "JP", "text": "약속 시간에 늦는 사람을 이해하기 힘들다."},
    {"type": "JP", "text": "예상 가능한 범위 내에서 업무가 진행되길 원한다."},
    {"type": "JP", "text": "준비가 완벽하지 않으면 수업에 들어가는 것이 불안하다."},
    {"type": "JP", "text": "목표를 달성했을 때의 성취감이 과정의 즐거움보다 크다."},
    {"type": "JP", "text": "주변에서 '철저하다'는 소리를 자주 듣는다."},
    {"type": "JP", "text": "메일을 받으면 즉시 답장하거나 처리한다."},
    {"type": "JP", "text": "무엇을 하든 기한을 정해두고 시작한다."},
    {"type": "JP", "text": "결론부터 말하는 대화 방식을 선호한다."},
    {"type": "JP", "text": "정해진 시간표대로 움직이는 것이 효율적이다."},
    {"type": "JP", "text": "물건은 항상 정해진 위치에 있어야 한다."},
    {"type": "JP", "text": "갑작스러운 업무 지시보다 미리 공지된 업무가 좋다."},
    {"type": "JP", "text": "계획이 없는 자유로운 시간은 가끔 막막하게 느껴진다."},
]

MBTI_INFO = {
    "ISTJ": {
        "title": "청렴결백한 논리주의자 (A.dot 전문 교수진)",
        "description": "철저한 관리와 체계적인 수업 준비로 학생들에게 무한한 신뢰를 줍니다. 약속한 진도와 목표를 반드시 지켜내며, 동료들에게는 흔들림 없는 업무 처리 능력을 보여주는 든든한 파트너입니다.",
        "keywords": ["철저한 관리", "수업의 정석", "약속 이행", "신뢰의 아이콘"],
        "stats": [
            {"label": "학생 관리", "value": "철저한 정량적 관리 및 진도 준수"},
            {"label": "강의 스타일", "value": "원칙에 충실한 정석적인 강의"},
            {"label": "동료 협업", "value": "신뢰를 주는 묵묵한 업무 완수"},
            {"label": "상담 및 전문성", "value": "데이터 기반의 객관적 분석 상담"}
        ]
    },
    "ISFJ": {
        "title": "용감한 수호자 (따뜻한 성장의 동반자)",
        "description": "학생 한 명 한 명의 컨디션과 학습 변화를 세심하게 살피는 '섬세한 티칭'이 강점입니다. 학생들에게는 마음 기댈 수 있는 멘토이며, 동료들에게는 보이지 않는 곳에서도 묵묵히 협조하는 최고의 팀플레이어입니다.",
        "keywords": ["세심한 관찰", "감성적 공감", "성실한 조력", "따뜻한 리더십"],
        "stats": [
            {"label": "학생 관리", "value": "일대일 밀착 감성 케어 및 응원"},
            {"label": "강의 스타일", "value": "학생의 속도에 맞춘 친절한 설명"},
            {"label": "동료 협업", "value": "동료를 먼저 배려하는 헌신적 태도"},
            {"label": "상담 및 전문성", "value": "안정감과 신뢰를 주는 공감형 상담"}
        ]
    },
    "INFJ": {
        "title": "선의의 옹호자 (학생의 미래를 그리는 설계자)",
        "description": "학생들의 성적 너머의 잠재력을 꿰뚫어 보고 진심 어린 동기부여를 제공합니다. 동료들에게는 학원의 비전과 교육적 가치를 공유하며 깊은 영감을 주는 사려 깊은 조언자 역할을 합니다.",
        "keywords": ["미래 통찰", "진심 어린 멘토링", "깊은 교육철학", "비전 제시"],
        "stats": [
            {"label": "학생 관리", "value": "학생의 잠재 성장을 이끄는 인내심"},
            {"label": "강의 스타일", "value": "깊은 울림과 통찰을 주는 강의"},
            {"label": "동료 협업", "value": "팀의 가치와 비전을 조율하는 조언자"},
            {"label": "상담 및 전문성", "value": "학습 의욕을 고취하는 진정성 있는 멘토링"}
        ]
    },
    "INTJ": {
        "title": "용의주도한 전략가 (스마트한 성적 향상의 마스터)",
        "description": "가장 효율적인 학습 경로를 설계하여 학생들에게 명확한 성적 향상 솔루션을 제시합니다. 동료들에게는 논리적이고 객관적인 피드백을 통해 팀의 업무 효율을 극대화하는 브레인 역할을 수행합니다.",
        "keywords": ["효율적 커리큘럼", "성적 향상 솔루션", "분석적 티칭", "전략적 직관"],
        "stats": [
            {"label": "학생 관리", "value": "최적화된 개인별 학습 로드맵 구축"},
            {"label": "강의 스타일", "value": "군더더기 없는 논리적 지식 전달"},
            {"label": "동료 협업", "value": "전략적 방향성을 제시하는 분석적 조력"},
            {"label": "상담 및 전문성", "value": "데이터와 원리 기반의 고효율 솔루션"}
        ]
    },
    "ISTP": {
        "title": "만능 재주꾼 (현장의 위기 관리 마스터)",
        "description": "수업 현장에서 발생하는 돌발 상황에 매우 침착하게 대처하며, 학생들에게는 군더더기 없는 명쾌한 핵심 수업을 제공합니다. 동료들에게는 복잡한 문제를 단순하게 해결해주는 실천적인 해결사입니다.",
        "keywords": ["명쾌한 핵심 수업", "침착한 대처", "실무 최적화", "실용적 교육"],
        "stats": [
            {"label": "학생 관리", "value": "현장 상황에 따른 유연하고 실용적인 관리"},
            {"label": "강의 스타일", "value": "핵심만 짚어주는 실무형 고효율 수업"},
            {"label": "동료 협업", "value": "필요한 순간 담백하게 돕는 실천적 태도"},
            {"label": "상담 및 전문성", "value": "도구와 기술을 활용한 명확한 문제 해결"}
        ]
    },
    "ISFP": {
        "title": "호기심 많은 예술가 (매력 넘치는 소통 강사)",
        "description": "학생들의 감수성을 자극하는 창의적인 비유와 수업 방식으로 지루할 틈 없는 강의를 선사합니다. 동료들에게는 유연하고 수용적인 태도로 팀의 분위기를 부드럽게 만드는 활력소 같은 존재입니다.",
        "keywords": ["창의적 교수법", "유연한 소통", "현재 집중형", "감각적 티칭"],
        "stats": [
            {"label": "학생 관리", "value": "권위적이지 않은 친구 같은 친근한 관리"},
            {"label": "강의 스타일", "value": "감각적이고 몰입감 있는 교수법"},
            {"label": "동료 협업", "value": "갈등을 최소화하는 유연한 태도"},
            {"label": "상담 및 전문성", "value": "학생의 감정을 섬세하게 이해하는 상담"}
        ]
    },
    "INFP": {
        "title": "열정적인 중재자 (꿈을 찾아주는 따뜻한 멘토)",
        "description": "학생들의 마음을 깊이 이해하고 성장을 응원하는 가장 따뜻한 강사입니다. 동료들 사이에서는 갈등을 중재하고 서로의 개성을 존중하는 화합의 분위기를 만드는 데 탁월한 능력을 발휘합니다.",
        "keywords": ["이해심", "학생 응원단", "화합의 중심", "이타적 교육"],
        "stats": [
            {"label": "학생 관리", "value": "참 편안하고 수용적인 학습 환경 조성"},
            {"label": "강의 스타일", "value": "개개인의 개성을 존중하는 개별화 티칭"},
            {"label": "동료 협업", "value": "팀 동료의 어려움에 진심으로 귀 기울임"},
            {"label": "상담 및 전문성", "value": "자존감을 높여주는 정서적 동반자"}
        ]
    },
    "INTP": {
        "title": "논리적인 사색가 (언어학적 원리 분석가)",
        "description": "단순 암기가 아닌 영어의 원리를 논리적으로 풀어내어 학생들의 지적 호기심을 충족시킵니다. 동료들에게는 새로운 교육 이론이나 효율적인 시스템을 끊임없이 고민하는 학구적인 자극을 줍니다.",
        "keywords": ["원리 중심 설명", "지적 자극", "창의적 이론", "비판적 사고"],
        "stats": [
            {"label": "학생 관리", "value": "학생의 논리적 사고를 일깨우는 질문법"},
            {"label": "강의 스타일", "value": "언어학적 원리를 꿰뚫는 분석적 강의"},
            {"label": "동료 협업", "value": "끊임 없는 전문 지식 탐구와 공유"},
            {"label": "상담 및 전문성", "value": "어려운 난제를 창의적으로 해석하는 능력"}
        ]
    },
    "ESTP": {
        "title": "모험을 즐기는 사업가 (압도적인 수업 장악력)",
        "description": "폭발적인 에너지로 수업을 장악하여 학생들을 몰입시키는 능력이 뛰어납니다. 동료들에게는 강한 추진력과 생생한 현장 감각을 공유하며 팀에 에너지를 불어넣는 액티브한 리더입니다.",
        "keywords": ["에너지 넘치는 강의", "수업 장악력", "생생한 티칭", "빠른 실행력"],
        "stats": [
            {"label": "학생 관리", "value": "강한 흡입력으로 학생의 행동을 유도"},
            {"label": "강의 스타일", "value": "지루할 틈 없는 생동감 넘치는 강의"},
            {"label": "동료 협업", "value": "학생 및 동료들과의 시원시원한 관계망"},
            {"label": "상담 및 전문성", "value": "실질적이고 즉각적인 문제 해결 상담"}
        ]
    },
    "ESFP": {
        "title": "자유로운 영혼의 연예인 (수업의 주인공, 분위기 메이커)",
        "description": "가장 재미있고 지루하지 않은 수업을 만드는 재치 넘치는 강사입니다. 학생들에게는 학원이 즐거운 장소가 되게 하며, 동료들 사이에서는 언제나 웃음과 긍정적인 에너지를 전파하는 존재입니다.",
        "keywords": ["재미있는 수업", "낙천적 에너지", "뛰어난 사교성", "즉흥적 티칭"],
        "stats": [
            {"label": "학생 관리", "value": "낙천적인 마인드 전파와 라포 형성"},
            {"label": "강의 스타일", "value": "최고의 쇼맨십과 유머러스한 티칭"},
            {"label": "동료 협업", "value": "팀 전체의 사기를 북돋는 분위기 메이커"},
            {"label": "상담 및 전문성", "value": "사람을 끌어당기는 압도적인 친화력"}
        ]
    },
    "ENFP": {
        "title": "재기발랄한 활동가 (긍정의 변화를 만드는 파이오니어)",
        "description": "끊임없이 새로운 수업 아이디어를 제안하며 학생들에게 '할 수 있다'는 긍정적인 믿음을 심어줍니다. 동료들에게는 주변을 격려하고 새로운 프로젝트에 활력을 더해주는 창의적인 협력자입니다.",
        "keywords": ["긍정 메이커", "아이디어 뱅크", "열정적인 협력", "창의적 학습법"],
        "stats": [
            {"label": "학생 관리", "value": "할 수 있다는 긍정의 에너지를 심어줌"},
            {"label": "강의 스타일", "value": "지루함을 거부하는 역동적인 에너지"},
            {"label": "동료 협업", "value": "늘 새로운 교육 아이디어를 팀에 공급"},
            {"label": "상담 및 전문성", "value": "누구와도 금방 친해지는 탁월한 공감력"}
        ]
    },
    "ENTP": {
        "title": "뜨거운 논쟁을 즐기는 변론가 (끊임없이 혁신하는 브레인)",
        "description": "틀에 박힌 형식을 거부하고 새로운 관점에서 영어 학습의 해법을 제시하여 학생들에게 지적 해방감을 줍니다. 동료들에게는 끊임없는 질문과 토론을 통해 고이고 썩는 것을 방지하는 혁신의 촉매제입니다.",
        "keywords": ["혁신적 통찰", "지적 토론", "다재다능한 수업", "문제 본질 파악"],
        "stats": [
            {"label": "학생 관리", "value": "고정관념을 깨는 예리한 동기부여"},
            {"label": "강의 스타일", "value": "기존 방식을 뛰어넘는 실험적 교수법"},
            {"label": "동료 협업", "value": "생동감 있는 토론형 업무 문화 구축"},
            {"label": "상담 및 전문성", "value": "트렌드를 빨리 읽고 교육에 반영하는 통찰력"}
        ]
    },
    "ESTJ": {
        "title": "엄격한 관리자 (확실한 결과 보장 마스터)",
        "description": "결과에 집중하며 학생들을 체계적으로 통제하여 단기간에 성과를 도출합니다. 동료 임직원들에게는 맡겨진 업무를 완벽하게 조직하고 마무리지어 팀 전체의 생산성을 높이는 핵심 인재입니다.",
        "keywords": ["결과 중심 티칭", "현실적 운영", "강력한 추진", "조직적 관리"],
        "stats": [
            {"label": "학생 관리", "value": "단호하고 책임감 있는 정량적 관리"},
            {"label": "강의 스타일", "value": "학습 체계를 세우는 강력한 리더십 강의"},
            {"label": "동료 협업", "value": "계획한 바를 끝까지 완수하는 고도의 실행력"},
            {"label": "상담 및 전문성", "value": "현실적인 대안과 지침을 주는 카리스마"}
        ]
    },
    "ESFJ": {
        "title": "사교적인 외교관 (모두에게 사랑받는 강사)",
        "description": "학생들과의 친밀한 유대를 바탕으로 소속감을 느끼게 하며 정서적인 안정을 제공합니다. 동료들 사이에서는 타인의 어려움을 가장 먼저 돕고 조화로운 업무 환경을 만드는 '학원의 중심' 역할을 수행합니다.",
        "keywords": ["친절한 티칭", "협력적 분위기", "사교적 관리", "세심한 배려"],
        "stats": [
            {"label": "학생 관리", "value": "모든 학생을 품어내는 자상한 관리"},
            {"label": "강의 스타일", "value": "누구나 이해하기 쉬운 친절한 교수법"},
            {"label": "동료 협업", "value": "동료 임직원들을 챙기는 구심점 역할"},
            {"label": "상담 및 전문성", "value": "사람의 마음을 움직이는 사교적 상담 전문성"}
        ]
    },
    "ENFJ": {
        "title": "정의로운 사회운동가 (카리스마 넘치는 등대)",
        "description": "강한 카리스마와 따뜻한 리더십으로 학생들을 이끌어 단순 성적 그 이상의 목표를 보게 합니다. 동료들에게는 팀의 목표를 정의롭게 설정하고 모두가 함께 성장하도록 북돋는 최고의 리더입니다.",
        "keywords": ["리더십 티칭", "이타적 성장", "팀워크 중시", "영향력 있는 상담"],
        "stats": [
            {"label": "학생 관리", "value": "학생들의 전인적 성장을 이끄는 포용력"},
            {"label": "강의 스타일", "value": "강한 설득력과 신뢰를 주는 명품 강의"},
            {"label": "동료 협업", "value": "모두가 주인공이 되게 만드는 탁월한 조율"},
            {"label": "상담 및 전문성", "value": "진심 어린 눈높이 상담 전문가"}
        ]
    },
    "ENTJ": {
        "title": "대담한 통솔자 (압도적인 성장을 주도하는 장군)",
        "description": "정확한 비전과 강력한 카리스마로 학생들의 한계를 시험하고 극복하게 만듭니다. 동료들에게는 팀이 나아가야 할 큰 그림을 제시하고 장애물을 정면으로 돌파해내는 최고의 전략지휘관입니다.",
        "keywords": ["결단력 있는 리더", "비전 제시자", "압도적 효율", "카리스마 티칭"],
        "stats": [
            {"label": "학생 관리", "value": "정해진 목표를 뚫고 나가는 강인한 훈련"},
            {"label": "강의 스타일", "value": "시간 대비 최고의 완급 조절과 명쾌함"},
            {"label": "동료 협업", "value": "목표를 향해 팀을 결단력 있게 이끄는 리더십"},
            {"label": "상담 및 전문성", "value": "승리하는 입시 전략과 강력한 비전 제시"}
        ]
    }
}


def save_to_csv(info_dict, mbti, scores):
    """결과를 로컬 CSV 파일에 저장하는 함수"""
    file_name = "test_results.csv"
    file_exists = os.path.isfile(file_name)
    
    with open(file_name, mode="a", encoding="utf-8-sig", newline="") as f:
        writer = csv.writer(f)
        # 파일이 처음 생성될 때 헤더 추가
        if not file_exists:
            writer.writerow(["일시", "지점명", "강사명", "CRM아이디", "이메일", "MBTI", "E", "I", "S", "N", "T", "F", "J", "P"])
        
        writer.writerow([
            datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            info_dict.get('branch', ''),
            info_dict.get('name', ''),
            info_dict.get('crm_id', ''),
            info_dict.get('email', ''),
            mbti,
            scores['E'], scores['I'], scores['S'], scores['N'],
            scores['T'], scores['F'], scores['J'], scores['P']
        ])

@app.route("/")
def index():
    # 문항 섞기
    shuffled_questions = list(QUESTIONS_DATA)
    random.shuffle(shuffled_questions)
    for i, q in enumerate(shuffled_questions):
        q["id"] = f"q{i}"
    return render_template("index.html", questions=shuffled_questions)

@app.route("/submit", methods=["POST"])
def submit():
    try:
        data = request.form
        user_info = {
            "branch": data.get("branch_name", "").strip(),
            "name": data.get("user_name", "").strip() or "익명",
            "crm_id": data.get("crm_id", "").strip(),
            "email": data.get("email_address", "").strip()
        }
        
        scores = {"E": 0, "I": 0, "S": 0, "N": 0, "T": 0, "F": 0, "J": 0, "P": 0}

        for key, value in data.items():
            if not key.startswith("q") or key.endswith("_type"):
                continue
            
            q_type = data.get(f"{key}_type")
            if q_type and len(q_type) == 2:
                first, second = q_type[0], q_type[1]
                if value == "Y": scores[first] += 1
                else: scores[second] += 1

        mbti = (("E" if scores["E"] >= scores["I"] else "I") +
                ("S" if scores["S"] >= scores["N"] else "N") +
                ("T" if scores["T"] >= scores["F"] else "F") +
                ("J" if scores["J"] >= scores["P"] else "P"))

        # 로컬 CSV 저장
        # save_to_csv(user_info, mbti, scores)

        return render_template("result.html", 
                               name=user_info["name"], 
                               mbti=mbti, 
                               scores=scores, 
                               info=MBTI_INFO.get(mbti, {}))
    except Exception as e:
        return f"오류 발생: {e}"

if __name__ == "__main__":
    port = 5000
    def open_browser():
        webbrowser.open(f"http://127.0.0.1:{port}")
    
    threading.Timer(1.0, open_browser).start()
    app.run(host="127.0.0.1", port=port, debug=False)

